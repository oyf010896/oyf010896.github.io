{"title":"graylog的安装部署","slug":"graylog","date":"2022-07-29T03:13:29.000Z","updated":"2022-07-29T04:22:21.559Z","comments":true,"path":"api/articles/graylog.json","photos":[],"link":"","excerpt":null,"covers":null,"content":"<h1 id=\"graylog的安装部署\"><a href=\"#graylog的安装部署\" class=\"headerlink\" title=\"graylog的安装部署\"></a>graylog的安装部署</h1><p><a href=\"https://blog.csdn.net/weixin_41004350/article/details/87253316\">https://blog.csdn.net/weixin_41004350/article/details/87253316</a></p>\n<p>  日志管理系统，大家普遍知道的都是ELK的解决方案，但是ELK要实现认证和一些状态监控，需要安装x-pack插件包，但是x-pack是要收费的，当然可以选择破解，但是比较麻烦。而且ELK是一个解决方案，在其中包含很多软件，不单elasticsearch,kibana,logstash,还需要redis或kafaka，收集日志还需要不同的beats，整个结构非常复杂，且占用较多资源，要想完全搞懂需要较长时间。</p>\n<p>  但是很多时候，公司系统并不大，使用ELK的成本太高，可以使用一些替代方案，除了ELK还有很多日志管理工具，这里就介绍其中的一个很不错的日志方案：Graylog，Graylog是一个可以跟ELK相提并论的日志管理的后起之秀，一个开源的 log 收容器，背后的储存是搭配 mongodb，而搜寻引擎则由 elasticsearch 提供，自身集成web端，不需要单独部署，目前最新为3.0版本。</p>\n<p>  下面就详细记录一下，graylog3.0的安装与配置和使用。<a href=\"http://docs.graylog.org/en/3.0/index.html\">官方文档入口</a></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h2 id=\"一、准备\"><a href=\"#一、准备\" class=\"headerlink\" title=\"一、准备\"></a>一、准备</h2><p>安装jdk8，安装方案，详见《<a href=\"https://blog.csdn.net/weixin_41004350/article/details/78491472\">centos7.2 安装 JDK-1.8</a>》</p>\n<p>安装依赖包</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install epel-release -y</span><br><span class=\"line\">yum install pwgen -y</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"二、安装mongodb\"><a href=\"#二、安装mongodb\" class=\"headerlink\" title=\"二、安装mongodb\"></a>二、安装mongodb</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">添加源</span><br><span class=\"line\">vim /etc/yum.repos.d/mongodb-org-3.6.repo</span><br><span class=\"line\">----------------------------------------------------------------</span><br><span class=\"line\">[mongodb-org-4.0]</span><br><span class=\"line\">name=MongoDB Repository</span><br><span class=\"line\">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.0/x86_64/</span><br><span class=\"line\">gpgcheck=1</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc</span><br><span class=\"line\">-----------------------------------------------------------------</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装</span></span><br><span class=\"line\">yum install -y mongodb-org</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">systemctl <span class=\"built_in\">enable</span> mongod</span></span><br><span class=\"line\">systemctl start mongod</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"三、安装elasticsearch\"><a href=\"#三、安装elasticsearch\" class=\"headerlink\" title=\"三、安装elasticsearch\"></a>三、安装elasticsearch</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">graylog3.0 使用的elasticsearch不低于5.6.13版本，我这里用的最新版6.x</span></span><br><span class=\"line\">vim /etc/yum.repos.d/elasticsearch.repo</span><br><span class=\"line\">----------------------------------------------------------------</span><br><span class=\"line\">[elasticsearch-6.x]</span><br><span class=\"line\">name=Elasticsearch repository for 6.x packages</span><br><span class=\"line\">baseurl=https://artifacts.elastic.co/packages/6.x/yum</span><br><span class=\"line\">gpgcheck=1</span><br><span class=\"line\">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">autorefresh=1</span><br><span class=\"line\">type=rpm-md</span><br><span class=\"line\">----------------------------------------------------------------</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装</span></span><br><span class=\"line\">yum install elasticsearch</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改配置，设置JAVA_HOME</span></span><br><span class=\"line\">vim /etc/sysconfig/elasticsearch</span><br><span class=\"line\">----------------------------------------------------------------</span><br><span class=\"line\">JAVA_HOME=/usr/local/jdk1.8.0_191   # 填上自己的java_home路径  默认的为/usr/bin/java</span><br><span class=\"line\">----------------------------------------------------------------</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动</span></span><br><span class=\"line\">systemctl enable elasticsearch</span><br><span class=\"line\">systemctl start elasticsearch</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"四、安装Groylog\"><a href=\"#四、安装Groylog\" class=\"headerlink\" title=\"四、安装Groylog\"></a>四、安装Groylog</h2><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -Uvh https://packages.graylog2.org/repo/packages/graylog-3.0-repository_latest.rpm</span><br><span class=\"line\">yum install graylog-server -y</span><br></pre></td></tr></table></figure>\n\n<p>修改配置， password_secret和root_password_sha2是必须的，不设置则无法启动，设置方法如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改配置</span></span><br><span class=\"line\">vim /etc/graylog/server/server.conf</span><br><span class=\"line\">---------------------------------------------------------------------------------</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">passworde_secret可以通过命令：pwgen -N 1 -s 96 来随机生成，下面就是我随机生成的</span></span><br><span class=\"line\">password_secret = 6Z06fZHU2DwuOf9X8fhnvphCd3OM7oqwLECRRcejvjpieSvVtwu08yHYHIKDi56bAxRvtCOZ3xKKiBqyt00XYCgVa0oETB0L</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">admin用户密码生成命令：<span class=\"built_in\">echo</span> -n yourpassword | <span class=\"built_in\">sha256sum</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">生成后，请记住你的 YourPassword</span></span><br><span class=\"line\">root_password_sha2 = e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">admin用户邮箱</span></span><br><span class=\"line\">root_email = &quot;root@example.com&quot;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">时区</span></span><br><span class=\"line\">root_timezone = Asia/Shanghai</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">elasticsearch 相关配置</span></span><br><span class=\"line\">elasticsearch_hosts = http://127.0.0.1:9200</span><br><span class=\"line\">elasticsearch_shards =1 </span><br><span class=\"line\">elasticsearch_replicas = 0</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">mongodb 连接配置，这里直接本机起的mongodb，没有设置验证</span></span><br><span class=\"line\">mongodb_uri = mongodb://localhost/graylog</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">电子邮件smtp,设置为自己的邮箱smtp服务</span></span><br><span class=\"line\">transport_email_enabled = true</span><br><span class=\"line\">transport_email_hostname = smtp.exmail.qq.com</span><br><span class=\"line\">transport_email_port = 465</span><br><span class=\"line\">transport_email_use_auth = true</span><br><span class=\"line\">transport_email_use_tls = false</span><br><span class=\"line\">transport_email_use_ssl = true</span><br><span class=\"line\">transport_email_auth_username = root@example.com</span><br><span class=\"line\">transport_email_auth_password = 123456</span><br><span class=\"line\">transport_email_subject_prefix = [graylog]</span><br><span class=\"line\">transport_email_from_email = root@example.com</span><br><span class=\"line\">transport_email_web_interface_url = http://graylog.example.com</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">网络访问相关，重要，graylog3比2.x版本简洁了很多网络配置，只需配置http_bind_address即可。</span></span><br><span class=\"line\">http_bind_address = 0.0.0.0:9000</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置外网地址，我这里用了域名+nginx做反向代理，所以外网地址如下。没有的话就直接就用外网ip+port，如：http://外网ip:9000/</span></span><br><span class=\"line\">http_publish_uri = http://graylog.example.com/</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">http_external_uri = http://graylog.example.com/ 单节点的话，此配置不需要配置，默认使用http_publish_uri</span></span><br><span class=\"line\">---------------------------------------------------------------------------------</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动需要手动设置Java路径</span></span><br><span class=\"line\">vim /etc/sysconfig/graylog-server</span><br><span class=\"line\">---------------------------------------------------------------------------------</span><br><span class=\"line\">JAVA=/usr/local/jdk1.8.0_191/bin/java</span><br><span class=\"line\">---------------------------------------------------------------------------------</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动服务</span></span><br><span class=\"line\">systemctl enable graylog-server</span><br><span class=\"line\">systemctl start graylog-server</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"五、访问web页面\"><a href=\"#五、访问web页面\" class=\"headerlink\" title=\"五、访问web页面\"></a>五、访问web页面</h2><p> 按照上面配置，直接配置成外网ip地址，那么直接访问 http:&#x2F;&#x2F;外网ip:9000，就可以进入web登陆页面</p>\n<p>输入用户密码登陆</p>\n<h2 id=\"六、安装Graylog-Sidecar（Graylog-Collector-Sidecar）\"><a href=\"#六、安装Graylog-Sidecar（Graylog-Collector-Sidecar）\" class=\"headerlink\" title=\"六、安装Graylog Sidecar（Graylog Collector Sidecar）\"></a>六、安装Graylog Sidecar（Graylog Collector Sidecar）</h2><p>  Graylog Sidecar是一个轻量级配置管理系统，适用于不同的日志收集器，也称为后端。Graylog节点充当包含日志收集器配置的集中式集线器。在支持的消息生成设备&#x2F;主机上，Sidecar可以作为服务（Windows主机）或守护程序（Linux主机）运行。进行在不同机器上进行日志的采集并发送到graylog server</p>\n<p>  在graylog3.0版本以前，称为Graylog Collector Sidecar，在3.0中改为了Graylog Sidecar，在官方文档中有详细安装指导：<a href=\"http://docs.graylog.org/en/3.0/pages/sidecar.html\">官方文档入口</a>。这里也参考进行安装。版本对照表如下，首先去github上下载相应的rpm安装包。<a href=\"https://github.com/Graylog2/collector-sidecar/releases\">官方GITHUB下载地址</a></p>\n<table>\n<thead>\n<tr>\n<th><strong>Sidecar version</strong></th>\n<th>Graylog server version</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1.0.x</td>\n<td>3.0.x</td>\n</tr>\n<tr>\n<td>0.1.x</td>\n<td>2.2.x,2.3.x,2.4.x,2.5.x,3.0.x</td>\n</tr>\n<tr>\n<td>0.0.9</td>\n<td>2.1.x</td>\n</tr>\n</tbody></table>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装</span></span><br><span class=\"line\">rpm -i graylog-sidecar-1.0.0-1.x86_64.rpm</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改配置</span></span><br><span class=\"line\">vim /etc/graylog/sidecar/sidecar.yml</span><br><span class=\"line\">----------------------------------------------------------------------------</span><br><span class=\"line\">server_url: &quot;hhttp://graylog.example.com/api/&quot;    # api的外网地址</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">api token 必要的，不然启动不了，token需要在web界面上进行手动创建</span></span><br><span class=\"line\">server_api_token: &quot;1jq26cssvc6rj4qac4bt9oeeh0p4vt5u5kal9jocl1g9mdi4og3n&quot;</span><br><span class=\"line\">node_name: &quot;graylog-server-localhost&quot;    # 自定义节点名称</span><br><span class=\"line\">update_interval: 10</span><br><span class=\"line\">send_status: true</span><br><span class=\"line\">----------------------------------------------------------------------------</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装系统服务</span></span><br><span class=\"line\">graylog-sidecar -service install</span><br><span class=\"line\">systemctl start graylog-sidecar</span><br></pre></td></tr></table></figure>\n\n<p>手动创建server_api_token。如图：</p>\n<p>ok，到此就可以启动graylog-sidecar了。启动后，在web界面上就可以看到一个节点了，然后下面记录怎么手动配置这个节点的日志采集。首先需要创建一个beats的input，因为我要要用filebeat进行日志采集。</p>\n<p>然后就需要定义sidecar的filebeat配置，用这个配置来启动filebeat进行日志采集，并输入到上面定义的beats input。但是graylog3.0中，graylog sidecar的linux版本不包含filebeat(3.0版本之前是默认包含filebeat的)，需要自己手动下载安装filebeat，安装非常简单，通过官方下载页面，直接下载rpm包进行安装就行： <a href=\"https://www.elastic.co/downloads/beats/filebeat\">官方下载地址</a></p>\n<p>PS：我这里是演示的用filebeat进行日志采集，如果用nxlog进行采集，同样的需要安装nxlog程序。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装，目前最新版6.6.0</span></span><br><span class=\"line\">rpm -i filebeat-6.6.0-x86_64.rpm</span><br></pre></td></tr></table></figure>\n\n\n\n<p>ok，就这样就ok啦，然后下面在web界面上进行配置</p>\n<p>这里我以采集本机上graylog-server的日志为例子，自定义变量中定义beats input服务的ip和端口，使得sidecar采集器能将数据输入指定input，并可以在所有配置中直接复用。</p>\n<p>配置创建完成后，需要将配置与指定sidecar进行联系，然后sidecar就能以执行配置启动filebeat进行日志采集。如图：</p>\n<p>然后就能在web界面上，看到采集到的graylog-server的日志</p>\n<p>用centos自带的日志系统</p>\n<p>公司很多的虚拟机都是centos7的操作系统，带有rsyslog服务，可以使用syslog协议将系统日志发送到graylog上进行收集，可以指定端口。**<br>**</p>\n<p> 必须注意的是， 很多linux发行版的非root用户是无法使用1024以下的端口的，这些被称为特权端口。本次使用udp1515端口收集。</p>\n<p>使用rsyslog转发syslog消息很容易。充分利用日志的唯一重要事项是遵循 RFC 5424。按照如下示例配置您的rsyslog守护程序将RFC 5424日期发送到Graylog syslog输入：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">touch /etc/rsyslog.d/greylog.conf                  #创建rsyslog额外配置文件</span><br><span class=\"line\">cat &lt;&lt; EOF &gt; /etc/rsyslog.d/greylog.conf             #编辑配置文件</span><br><span class=\"line\">*.* @192.168.99.40:1515;RSYSLOG_SyslogProtocol23Format       #*.* 代表linux中所有模块所有级别的日志，@代表使用udp协议，@@代表使用tcp协议，192.168.99.40:1515greylog主机的IP和收集端口</span><br><span class=\"line\">EOF                                 #RSYSLOG_SyslogProtocol23Format 代表syslog协议格式模板</span><br></pre></td></tr></table></figure>\n\n<p>配置完成后，重启rsyslog服务</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl restart rsyslog</span><br><span class=\"line\">systemctl enable rsyslog</span><br></pre></td></tr></table></figure>\n\n\n\n<p>防火墙加日志在防火墙的配置上写日志服务器ip和端口</p>\n","categories":[],"tags":[]}