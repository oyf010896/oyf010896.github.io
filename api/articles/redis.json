{"title":"centos7 下安装redis4.0集群","slug":"redis","date":"2022-07-29T03:13:29.000Z","updated":"2022-07-29T04:10:34.901Z","comments":true,"path":"api/articles/redis.json","photos":[],"link":"","excerpt":null,"covers":null,"content":"<h1 id=\"centos7-下安装redis4-0集群\"><a href=\"#centos7-下安装redis4-0集群\" class=\"headerlink\" title=\"centos7 下安装redis4.0集群\"></a>centos7 下安装redis4.0集群</h1><h5 id=\"1、环境\"><a href=\"#1、环境\" class=\"headerlink\" title=\"1、环境\"></a>1、环境</h5><p>· CentOS版本：CentOS 7</p>\n<p>· 三台主机(IP)：192.168.1.2、192.168.1.3、192.168.1.4</p>\n<p>· Redis版本：4.0.8</p>\n<h5 id=\"2、注意事项\"><a href=\"#2、注意事项\" class=\"headerlink\" title=\"2、注意事项\"></a>2、注意事项</h5><p> 2.1、安裝 GCC 编译工具 不然会有编译不过的问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y gcc g++ gcc-c++ make</span><br></pre></td></tr></table></figure>\n\n<p> 2.2、升级所有的包，防止出现版本过久不兼容问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y update</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"集群搭建\"><a href=\"#集群搭建\" class=\"headerlink\" title=\"集群搭建\"></a>集群搭建</h2><h3 id=\"安装Redis\"><a href=\"#安装Redis\" class=\"headerlink\" title=\"安装Redis\"></a>安装Redis</h3><h5 id=\"下载，解压，编译安装\"><a href=\"#下载，解压，编译安装\" class=\"headerlink\" title=\"下载，解压，编译安装\"></a>下载，解压，编译安装</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /opt</span><br><span class=\"line\">wget http://download.redis.io/releases/redis-*.*.*.tar.gz</span><br><span class=\"line\">ar xzf redis-*.*.*.tar.gz</span><br><span class=\"line\">cd redis-*.*.*.</span><br><span class=\"line\">make</span><br><span class=\"line\">如果因为上次编译失败，有残留的文件</span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">make distclean</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"创建节点\"><a href=\"#创建节点\" class=\"headerlink\" title=\"创建节点\"></a>创建节点</h5><p>1.首先在 第一台机器上 &#x2F;opt&#x2F;redis- <em>.</em>.*.目录下创建 redis-cluster 目录</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /opt/redis-*/redis-cluster</span><br></pre></td></tr></table></figure>\n\n<p>2.在 redis-cluster 目录下，创建名为7000、7001、7002的目录</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /opt/redis-*/redis-cluster\\</span><br><span class=\"line\">mkdir 7000 7001 7002</span><br></pre></td></tr></table></figure>\n\n<p>3.分别修改这三个配置文件，把如下redis.conf 配置内容粘贴进去</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">vi 7000/redis.conf</span> </span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">vi 7001/redis.conf</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">vi 7002/redis.conf</span></span><br><span class=\"line\">redis.conf 配置</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">端口7000,7001,7002</span></span><br><span class=\"line\">port 7000</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">默认ip为127.0.0.1，需要改为其他节点机器可访问的ip，否则创建集群时无法访问对应的端口，无法创建集群</span></span><br><span class=\"line\">bind 本机IP</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">redis后台运行</span></span><br><span class=\"line\">daemonize yes </span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">pidfile文件对应7000，7001，7002</span></span><br><span class=\"line\">pidfile /var/run/redis_7000.pid</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">开启集群，把注释<span class=\"comment\">#去掉</span></span></span><br><span class=\"line\">cluster-enabled yes</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">集群的配置，配置文件首次启动自动生成 7000，7001，7002</span>     </span><br><span class=\"line\">cluster-config-file nodes_7000.conf</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">请求超时，默认15秒，可自行设置</span></span><br><span class=\"line\">luster-node-timeout 10100</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">aof日志开启，有需要就开启，它会每次写操作都记录一条日志</span></span><br><span class=\"line\">appendonly yes</span><br></pre></td></tr></table></figure>\n\n<p>接着在另外两台机器上(10.91.250.147，10.91.250.148)重复以上三步，只是把目录改为7003、7004、7005、7006、7007、7008对应的配置文件也按照这个规则修改即可</p>\n<h3 id=\"启动集群\"><a href=\"#启动集群\" class=\"headerlink\" title=\"启动集群\"></a>启动集群</h3><p>#第一台机器上执行 3个节点</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"keyword\">for</span>((i=0;i&lt;=2;i++)); <span class=\"keyword\">do</span> /opt/redis-*/src/redis-server /opt/redis-*/redis-cluster/700<span class=\"variable\">$i</span>/redis.conf; <span class=\"keyword\">done</span></span></span><br></pre></td></tr></table></figure>\n\n<p>#第二台机器上执行 3个节点</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"keyword\">for</span>((i=3;i&lt;=5;i++)); <span class=\"keyword\">do</span> /opt/redis*/src/redis-server /opt/redis-*/redis-cluster/700<span class=\"variable\">$i</span>/redis.conf; <span class=\"keyword\">done</span></span></span><br></pre></td></tr></table></figure>\n\n<p>#第三台机器上执行 3个节点</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"keyword\">for</span>((i=6;i&lt;=8;i++)); <span class=\"keyword\">do</span> /opt/redi*/src/redis-server /opt/redis-*/redis-cluster/700<span class=\"variable\">$i</span>/redis.conf; <span class=\"keyword\">done</span></span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"检查服务\"><a href=\"#检查服务\" class=\"headerlink\" title=\"检查服务\"></a>检查服务</h3><p>检查各 Redis 各个节点启动情况</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ps -ef | grep redis           //redis是否启动成功</span><br><span class=\"line\">netstat -tnlp | grep redis    //监听redis端口</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装Ruby\"><a href=\"#安装Ruby\" class=\"headerlink\" title=\"安装Ruby\"></a>安装Ruby</h3><p>redis-trib.rb 这个工具构建redis集群的时候，redis requires Ruby version &gt;&#x3D; 2.2.2</p>\n<p>(无外网的话要进行ruby的下载解压进行cp)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://cache.ruby-lang.org/pub/ruby/2.3/ruby-2.3.5.tar.gz</span><br><span class=\"line\">tar zxvf  ruby-2.3.5.tar.gz</span><br><span class=\"line\">cd ruby-2.3.5</span><br><span class=\"line\">./configure  --prefix=/opt/ruby</span><br><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\">ln -s /opt/ruby/bin/ruby /usr/bin/ruby</span><br><span class=\"line\">ln -s /opt/ruby/bin/gem /usr/bin/gem</span><br><span class=\"line\">ruby -v　</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"安装rubygem-redis依赖\"><a href=\"#安装rubygem-redis依赖\" class=\"headerlink\" title=\"安装rubygem redis依赖\"></a>安装rubygem redis依赖</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://rubygems.org/downloads/redis-3.3.0.gem</span><br><span class=\"line\">gem install -l redis-3.3.0.gem</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建集群\"><a href=\"#创建集群\" class=\"headerlink\" title=\"创建集群\"></a>创建集群</h3><p>注意：在任意一台上运行，不要在每台机器上都运行，一台就够了，</p>\n<p>Redis 官方提供了 redis-trib.rb 这个工具，就在解压目录的 src 目录中</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> /redis/redis-*/src/redis-trib.rb create --replicas 1 IP</span><br><span class=\"line\">1:7000 IP1:7001 IP1:7002 IP2:7003 IP2:7004 IP2:7005 IP3:7006 IP3:7007 IP3:7008</span><br></pre></td></tr></table></figure>\n\n<p>出现以下内容</p>\n<p>[root@localhost redis-cluster]# &#x2F;opt&#x2F;redis&#x2F;redis-*&#x2F;src&#x2F;redis-trib.rb create –replicas 1 IP<br>1:7000 IP1:7001 IP1:7002 IP2:7003 IP2:7004 IP2:7005 IP3:7006 IP3:7007 IP3:7008</p>\n<p>&gt;&gt;&gt; Creating cluster</p>\n<p>&gt;&gt;&gt; Performing hash slots allocation on 9 nodes…</p>\n<p>Using 4 masters:10.91.250.146:700010.91.250.147:700310.91.250.148:700610.91.250.146:7001</p>\n<p>Adding replica 10.91.250.147:7004 to 10.91.250.146:7000</p>\n<p>Adding replica 10.91.250.148:7007 to 10.91.250.147:7003</p>\n<p>Adding replica 10.91.250.146:7002 to 10.91.250.148:7006</p>\n<p>Adding replica 10.91.250.147:7005 to 10.91.250.146:7001</p>\n<p>Adding replica 10.91.250.148:7008 to 10.91.250.146:7000M: 7c622ac191edd40dd61d9b79b27f6f69d02a5bbf 10.91.250.146:7000  slots:0-4095 (4096 slots) masterM: 44c81c15b01d992cb9ede4ad35477ec853d70723 10.91.250.146:7001  slots:12288-16383 (4096 slots) masterS: 38f03c27af39723e1828eb62d1775c4b6e2c3638 10.91.250.146:7002</p>\n<p>  replicates f1abb62a8c9b448ea14db421bdfe3f1d8075189cM: 987965baf505a9aa43e50e46c76189c51a8f17ec 10.91.250.147:7003  slots:4096-8191 (4096 slots) masterS: 6555292fed9c5d52fcf5b983c441aff6f96923d5 10.91.250.147:7004</p>\n<p>  replicates 7c622ac191edd40dd61d9b79b27f6f69d02a5bbfS: 2b5ba254a0405d4efde4c459867b15176f79244a 10.91.250.147:7005</p>\n<p>  replicates 44c81c15b01d992cb9ede4ad35477ec853d70723M: f1abb62a8c9b448ea14db421bdfe3f1d8075189c 10.91.250.148:7006  slots:8192-12287 (4096 slots) masterS: eb4067373d36d8a8df07951f92794e67a6aac022 10.91.250.148:7007</p>\n<p>  replicates 987965baf505a9aa43e50e46c76189c51a8f17ecS: 2919e041dd3d1daf176d6800dcd262f4e727f366 10.91.250.148:7008</p>\n<p>  replicates 7c622ac191edd40dd61d9b79b27f6f69d02a5bbf</p>\n<h4 id=\"Can-I-set-the-above-configuration-type-‘yes’-to-accept-yes\"><a href=\"#Can-I-set-the-above-configuration-type-‘yes’-to-accept-yes\" class=\"headerlink\" title=\"Can I set the above configuration? (type ‘yes’ to accept): yes\"></a>Can I set the above configuration? (type ‘yes’ to accept): yes</h4><h4 id=\"输入yes\"><a href=\"#输入yes\" class=\"headerlink\" title=\"输入yes\"></a>输入yes</h4><p>看到这个就表示集群创建成功</p>\n<p>Check for open slots</p>\n<p>&gt;&gt;&gt;Check slots coverage…[OK]  All 16384  slots   covered</p>\n<h3 id=\"关闭集群\"><a href=\"#关闭集群\" class=\"headerlink\" title=\"关闭集群\"></a>关闭集群</h3><p>这样也可以，推荐</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pkill redis</span><br></pre></td></tr></table></figure>\n\n\n\n<p>循环节点逐个关闭</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"keyword\">for</span>((i=0;i&lt;=2;i++)); <span class=\"keyword\">do</span> /opt/redis-4.0.8/src/redis-cli -c -h 10.91.250.146 -p 700<span class=\"variable\">$i</span> shutdown; <span class=\"keyword\">done</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"keyword\">for</span>((i=3;i&lt;=5;i++)); <span class=\"keyword\">do</span> /opt/redis-4.0.8/src/redis-cli -c -h 10.91.250.147 -p 700<span class=\"variable\">$i</span> shutdown; <span class=\"keyword\">done</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"keyword\">for</span>((i=6;i&lt;=8;i++)); <span class=\"keyword\">do</span> /opt/redis-4.0.8/src/redis-cli -c -h 10.91.250.148 -p 700<span class=\"variable\">$i</span> shutdown; <span class=\"keyword\">done</span></span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"集群验证\"><a href=\"#集群验证\" class=\"headerlink\" title=\"集群验证\"></a>集群验证</h3><h4 id=\"连接集群测试\"><a href=\"#连接集群测试\" class=\"headerlink\" title=\"连接集群测试\"></a>连接集群测试</h4><p>参数 -C 可连接到集群，因为 redis.conf 将 bind 改为了ip地址，所以 -h 参数不可以省略，-p 参数为端口号</p>\n<p>我们在10.91.250.146机器redis 7000 的节点set 一个key</p>\n<p>&#x2F;opt&#x2F;redis-4.0.8&#x2F;src&#x2F;redis-cli -h IP -c -p 7000</p>\n<p>IP:7000&gt; cluster nodes</p>\n","categories":[],"tags":[]}