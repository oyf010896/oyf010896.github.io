{"title":"filecoin日常维护常用命令","slug":"filecoin","date":"2022-07-29T04:27:29.000Z","updated":"2022-07-29T06:13:34.817Z","comments":true,"path":"api/articles/filecoin.json","photos":[],"link":"","excerpt":null,"covers":null,"content":"<p>1、暂停apx任务派发</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lotus-miner worker-pause -uuid 2dcb294a-f981-450b-a3ea-0131e13f0893 --tt ap</span><br></pre></td></tr></table></figure>\n\n<p>2、放弃任务（先abort,在removed）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lotus-miner sealing <span class=\"built_in\">jobs</span> |grep -w <span class=\"string\">&#x27;f01038389-p1-172-20-6-69&#x27;</span> | awk <span class=\"string\">&#x27;&#123;print &quot;lotus-miner sealing abort &quot; $1&quot; &amp;&amp; lotus-miner sectors update-state --really-do-it &quot;$2&quot; Removed&quot; &#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>3、在日志中过滤删除失败扇区并删除</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">tail</span> -80 /opt/raid0/lotusminer/logs| egrep <span class=\"string\">&quot;(SealPreCommit2Failed|SealPreCommit1Failed|CommitFailed|CommitFinalizeFailed)&quot;</span> |awk <span class=\"string\">&#x27;&#123;print $5&#125;&#x27;</span> | grep <span class=\"string\">&#x27;,&#x27;</span> | egrep <span class=\"string\">&#x27;[0-9]&#123;3,6&#125;&#x27;</span> -o |awk <span class=\"string\">&#x27;&#123;print &quot;lotus-miner sectors update-state --really-do-it &quot; $1 &quot; Removed&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>4、批量移除worker任务</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lotus-miner sealing workers | awk <span class=\"string\">&#x27;/f0469055-p1-192-168-31-223/&#123;print $2&#125;&#x27;</span>| <span class=\"built_in\">tr</span> <span class=\"string\">&#x27;,&#x27;</span> <span class=\"string\">&#x27; &#x27;</span> | awk <span class=\"string\">&#x27;&#123;print &quot;lotus-miner worker-remove --uuid&quot;,$1&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>5、更改失败扇区状态为remove</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lotus-miner sectors update-state --really-do-it 85823 Removed</span><br></pre></td></tr></table></figure>\n\n<p>6、抽奖次数 isEligible true</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grep <span class=\"string\">&#x27;isEligible.*true&#x27;</span> /opt/raid0/lotusminer/logs |grep <span class=\"string\">&#x27;2021-08-05&#x27;</span>|<span class=\"built_in\">wc</span> -l</span><br></pre></td></tr></table></figure>\n\n<p>7、中奖次数 isWinner true</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grep <span class=\"string\">&#x27;&quot;isEligible&quot;: true&#x27;</span> /opt/raid0/lotusminer/logs|grep <span class=\"string\">&#x27;&quot;isWinner&quot;: true&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>8、查看日志是否孤块</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grep <span class=\"string\">&#x27;2021-08-12&#x27;</span> /opt/raid0/lotusminer/logs|grep <span class=\"string\">&#x27;mined new block&#x27;</span></span><br><span class=\"line\">看是否超时 看took时间 Winning Post用时，tooks对应值表示Winning Post完成时间，单位秒；超过25秒则有问题。</span><br></pre></td></tr></table></figure>\n\n<p>9、停止落盘任务修改落盘速率</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lotus-miner worker-pause --uuid all --tt fin</span><br><span class=\"line\">lotus-miner update-params-fin --tickets 45 --interval 6</span><br></pre></td></tr></table></figure>\n\n<p>10、组raid</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mdadm  --stop /dev/md*</span><br><span class=\"line\">mdadm --misc --zero-superblock   /dev/nvme*n1</span><br><span class=\"line\">组raid0</span><br><span class=\"line\">mdadm -Cv /dev/md0 -a <span class=\"built_in\">yes</span> -n 8  -l 0 /dev/nvme0n1   /dev/nvme1n1 /dev/nvme2n1  /dev/nvme3n1 /dev/nvme4n1 /dev/nvme5n1 /dev/nvme6n1 /dev/nvme7n1</span><br><span class=\"line\">mdadm -Cv /dev/md0 -a <span class=\"built_in\">yes</span> -n 4 -l 0 /dev/nvme0n1  /dev/nvme1n1  /dev/nvme2n1  /dev/nvme3n1</span><br><span class=\"line\">mdadm -D --scan &gt;/etc/mdadm.conf</span><br><span class=\"line\">mkfs.xfs -f /dev/md0</span><br><span class=\"line\"><span class=\"built_in\">ls</span> -l /dev/disk/by-uuid/|awk <span class=\"string\">&#x27;/md0/&#123;print &quot;echo \\&quot;/dev/disk/by-uuid/&quot;$9&quot; /opt/raid0 xfs defaults 0 0\\&quot; &gt;&gt;/etc/fstab&quot;&#125;&#x27;</span>|bash </span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /opt/raid0 -p</span><br><span class=\"line\">mount -a</span><br></pre></td></tr></table></figure>\n\n<p>注：mdadm 命令用法</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mdadm 使用参数</span><br><span class=\"line\">-a 检测设备名称；添加磁盘</span><br><span class=\"line\">-n 指定设备数量</span><br><span class=\"line\">-l 指定RAID级别</span><br><span class=\"line\">-C 创建</span><br><span class=\"line\">-v 显示创建过程</span><br><span class=\"line\">-f 模拟设备损坏</span><br><span class=\"line\">-r 移除设备</span><br><span class=\"line\">-Q 查看摘要信息</span><br><span class=\"line\">-D 查看详细信息</span><br><span class=\"line\">-S 停止RAID磁盘阵列</span><br><span class=\"line\">-x 备份盘</span><br><span class=\"line\"></span><br><span class=\"line\">启动raid</span><br><span class=\"line\">[root@node1 ~]<span class=\"comment\"># mdadm -As /dev/md0</span></span><br><span class=\"line\">mdadm: Fail to create md0 when using /sys/module/md_mod/parameters/new_array, fallback to creation via node</span><br><span class=\"line\">mdadm: /dev/md0 has been started with 2 drives.</span><br><span class=\"line\"></span><br><span class=\"line\">raid模拟故障  </span><br><span class=\"line\">[root@node1 mnt]<span class=\"comment\"># mdadm --manage --set-faulty /dev/md0 /dev/sdc</span></span><br><span class=\"line\">mdadm: <span class=\"built_in\">set</span> /dev/sdc faulty <span class=\"keyword\">in</span> /dev/md0</span><br><span class=\"line\"></span><br><span class=\"line\">raid 里面移除坏掉硬盘</span><br><span class=\"line\">[root@node1 mnt]<span class=\"comment\"># mdadm  /dev/md0 -r /dev/sdc</span></span><br><span class=\"line\">mdadm: hot removed /dev/sdc from /dev/md0</span><br><span class=\"line\"></span><br><span class=\"line\">raid 添加新的硬盘</span><br><span class=\"line\">[root@node1 mnt]<span class=\"comment\"># mdadm  /dev/md0 --add /dev/sdc</span></span><br><span class=\"line\">mdadm: re-added /dev/sdc</span><br><span class=\"line\"></span><br><span class=\"line\">raid 添加硬盘后 查看状态</span><br><span class=\"line\">[root@node1 mnt]<span class=\"comment\"># mdadm -D /dev/md0</span></span><br><span class=\"line\">/dev/md0:</span><br><span class=\"line\">          Version : 1.2</span><br><span class=\"line\">    Creation Time : Fri Jan 22 13:02:53 2021</span><br><span class=\"line\">       Raid Level : raid1</span><br><span class=\"line\">       Array Size : 9766304768 (9.10 TiB 10.00 TB)</span><br><span class=\"line\">    Used Dev Size : 9766304768 (9.10 TiB 10.00 TB)</span><br><span class=\"line\">     Raid Devices : 2</span><br><span class=\"line\">    Total Devices : 2</span><br><span class=\"line\">      Persistence : Superblock is persistent</span><br><span class=\"line\"></span><br><span class=\"line\">    Intent Bitmap : Internal</span><br><span class=\"line\"></span><br><span class=\"line\">      Update Time : Fri Jan 22 13:34:32 2021</span><br><span class=\"line\">            State : active, degraded, recovering</span><br><span class=\"line\">   Active Devices : 1</span><br><span class=\"line\">  Working Devices : 2</span><br><span class=\"line\">   Failed Devices : 0</span><br><span class=\"line\">    Spare Devices : 1</span><br><span class=\"line\"></span><br><span class=\"line\">Consistency Policy : unknown</span><br><span class=\"line\"></span><br><span class=\"line\">   Rebuild Status : 2% complete</span><br><span class=\"line\"></span><br><span class=\"line\">             Name : node1:0  (<span class=\"built_in\">local</span> to host node1)</span><br><span class=\"line\">             UUID : e11bea7b:ecb81ce2:e7d46423:367a4f82</span><br><span class=\"line\">           Events : 264</span><br><span class=\"line\"></span><br><span class=\"line\">   Number   Major   Minor   RaidDevice State</span><br><span class=\"line\">      0       8       32        0      spare rebuilding   /dev/sdc</span><br><span class=\"line\">      1       8      112        1      active <span class=\"built_in\">sync</span>   /dev/sdh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 停止解散raid</span></span><br><span class=\"line\">使用--stop或-S命令选项可以停止运行的阵列(注意： 停止前必须先umount)：</span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost eric4ever]<span class=\"comment\"># umount /mnt/md0</span></span><br><span class=\"line\">[root@localhost eric4ever]<span class=\"comment\"># mdadm -S /dev/md0 (或mdadm --stop /dev/md0)</span></span><br><span class=\"line\">mdadm: stopped /dev/md0</span><br><span class=\"line\"></span><br><span class=\"line\">[root@node1 ~]<span class=\"comment\"># mdadm  --stop /dev/md0</span></span><br><span class=\"line\">mdadm: stopped /dev/md0</span><br><span class=\"line\"></span><br><span class=\"line\">移除raid</span><br><span class=\"line\">mdadm --remove /dev/md0</span><br><span class=\"line\"></span><br><span class=\"line\">清除raid信息</span><br><span class=\"line\">mdadm --misc --zero-superblock /dev/sdb</span><br></pre></td></tr></table></figure>\n\n\n\n<p>11、处理remove扇区</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ll /opt/raid0/workercache/unsealed/ | awk <span class=\"string\">&#x27;&#123;print $9&#125;&#x27;</span> | awk -F<span class=\"string\">&#x27;-&#x27;</span> <span class=\"string\">&#x27;&#123;print $3&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> /tmp/tmp.tmp`;<span class=\"keyword\">do</span> lotus-miner sectors status <span class=\"variable\">$i</span>|<span class=\"built_in\">head</span>  -n2;<span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> /tmp/tmp.tmp `;<span class=\"keyword\">do</span> <span class=\"built_in\">rm</span> -rf /opt/raid0/workercache/*/*<span class=\"variable\">$i</span>*;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n","categories":[],"tags":[]}